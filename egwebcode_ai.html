<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>EG WEBCODE AI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --bg:#0b141a;
  --panel:#111b21;
  --bot:#202c33;
  --user:#005c4b;
  --text:#e9edef;
  --muted:#8696a0;
  --accent:#00a884;
}

*{box-sizing:border-box}

html,body{
  margin:0;
  height:100%;
  background:var(--bg);
  font-family:system-ui,Inter,sans-serif;
  color:var(--text);
  overflow:hidden;
}

/* HEADER */
header{
  height:56px;
  background:var(--panel);
  display:flex;
  align-items:center;
  padding:0 14px;
  gap:10px;
}

header img{
  height:32px;
}

header .info{
  flex:1;
}

header h1{
  font-size:15px;
  margin:0;
}

header span{
  font-size:12px;
  color:var(--muted);
}

/* CHAT */
#chat{
  height:calc(100vh - 112px);
  padding:12px;
  overflow-y:auto;
  background:url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAiIGhlaWdodD0iMTAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEwIiBoZWlnaHQ9IjEwIiBmaWxsPSIjMGIxNDFhIi8+PHBhdGggZD0iTTAgMTBoMTBWMHoiIGZpbGw9IiMwZDE3MWYiLz48L3N2Zz4=');
}

/* MESSAGES */
.msg{
  max-width:80%;
  padding:10px 12px;
  margin-bottom:8px;
  border-radius:10px;
  line-height:1.5;
  word-wrap:break-word;
}

.bot{
  background:var(--bot);
  border-top-left-radius:0;
}

.user{
  background:var(--user);
  margin-left:auto;
  border-top-right-radius:0;
}

/* CODE PANEL */
.code{
  margin-top:8px;
  background:#0b141a;
  border-radius:8px;
  padding:8px;
}

.code textarea{
  width:100%;
  height:180px;
  background:#0b141a;
  color:#9be0c3;
  border:none;
  resize:none;
  font-family:Consolas,monospace;
}

.actions{
  display:flex;
  gap:6px;
  margin-top:6px;
}

.actions input,
.actions select{
  flex:1;
  background:#111b21;
  border:1px solid #2a3942;
  color:var(--text);
  border-radius:6px;
  padding:6px;
}

.actions button{
  background:var(--accent);
  border:none;
  border-radius:6px;
  padding:6px 10px;
  font-weight:700;
  cursor:pointer;
}

/* FOOTER */
footer{
  height:56px;
  background:var(--panel);
  display:flex;
  align-items:center;
  padding:8px;
  gap:6px;
}

footer textarea{
  flex:1;
  height:40px;
  border-radius:20px;
  border:none;
  padding:10px 14px;
  resize:none;
  background:#2a3942;
  color:var(--text);
}

footer button{
  background:var(--accent);
  border:none;
  border-radius:50%;
  width:40px;
  height:40px;
  font-size:18px;
  cursor:pointer;
}

footer label{
  cursor:pointer;
  font-size:18px;
}
  /* ===== FOOTER FIX MOBILE ===== */
#footer{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:#111b21;
  display:flex;
  align-items:flex-end;
  gap:10px;
  padding:12px;
  border-top:1px solid #2a3942;
  z-index:999;
}

#footer .clip{
  font-size:26px;
  cursor:pointer;
  padding:8px;
}

#input{
  flex:1;
  min-height:52px;
  max-height:140px;
  background:#2a3942;
  border:none;
  border-radius:18px;
  padding:14px;
  font-size:16px;
  color:#e9edef;
  resize:none;
  line-height:1.4;
}

#sendBtn{
  min-width:90px;
  height:52px;
  background:#00a884;
  color:#000;
  border:none;
  border-radius:18px;
  font-size:16px;
  font-weight:800;
  cursor:pointer;
}

#sendBtn:active{
  transform:scale(.97);
}

/* Ajuste do chat para n√£o ficar atr√°s do footer */
#chat{
  padding-bottom:90px;
}
</style>
</head>

<body>

<header>
  <img src="logo.png">
  <div class="info">
    <h1>EG WEBCODE AI</h1>
    <span>online</span>
  </div>
</header>

<div id="chat"></div>

  <footer id="footer">
  <label for="file" class="clip">üìé</label>
  <input type="file" id="file" hidden accept=".html,.php,.js,.py,.txt">

  <textarea
    id="input"
    placeholder="Digite sua mensagem..."
    rows="1"
  ></textarea>

  <button id="sendBtn" onclick="send()">ENVIAR</button>
</footer>

<script>
const chat = document.getElementById("chat");
const input = document.getElementById("input");
const fileInput = document.getElementById("file");

const API_URL = "https://dtznnhhhlbzppuqldlwq.supabase.co/functions/v1/chat-free";
const API_KEY = "COLOQUE_SEU_TOKEN_AQUI";

let history = JSON.parse(localStorage.getItem("eg_history")||"[]");
let busy=false;

/* Render history */
history.forEach(m=>addMsg(m.role,m.text));

function cleanText(t){
  return t
    .replace(/[*`"]/g,"")
    .replace(/\n{3,}/g,"\n\n");
}

function addMsg(role,text){
  const d=document.createElement("div");
  d.className="msg "+role;
  d.textContent=text;
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
}

async function send(custom){
  if(busy)return;
  const text=custom||input.value.trim();
  if(!text)return;

  input.value="";
  busy=true;

  addMsg("user",text);
  history.push({role:"user",text});
  localStorage.setItem("eg_history",JSON.stringify(history.slice(-10)));

  const botDiv=document.createElement("div");
  botDiv.className="msg bot";
  chat.appendChild(botDiv);

  let full="";

  const res=await fetch(API_URL,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Accept":"text/event-stream",
      "Authorization":"Bearer "+API_KEY
    },
    body:JSON.stringify({
      messages: history.map(m=>({
        role:m.role==="user"?"user":"assistant",
        content:m.text
      }))
    })
  });

  const reader=res.body.getReader();
  const dec=new TextDecoder();

  while(true){
    const {value,done}=await reader.read();
    if(done)break;
    const chunk=dec.decode(value,{stream:true});
    chunk.split("\n").forEach(l=>{
      if(!l.startsWith("data:"))return;
      if(l.includes("[DONE]"))return;
      try{
        const j=JSON.parse(l.replace("data:",""));
        const t=j.choices?.[0]?.delta?.content;
        if(t){
          full+=t;
          botDiv.textContent=cleanText(full);
          chat.scrollTop=chat.scrollHeight;
        }
      }catch{}
    });
  }

  history.push({role:"bot",text:cleanText(full)});
  localStorage.setItem("eg_history",JSON.stringify(history.slice(-10)));
  busy=false;
}

fileInput.onchange=()=>{
  const f=fileInput.files[0];
  if(!f)return;
  const r=new FileReader();
  r.onload=()=>{
    send("Analise este arquivo:\n\n"+r.result);
  };
  r.readAsText(f);
};
</script>
<script>
(function(){

  /* ================= REMOVER SE J√Å EXISTIR ================= */
  const oldDownload = document.getElementById("eg-download-btn");
  if(oldDownload) oldDownload.remove();
  const oldClear = document.getElementById("eg-clear-btn");
  if(oldClear) oldClear.remove();

  /* ================= BOT√ÉO BAIXAR ================= */
  const downloadBtn = document.createElement("img");
  downloadBtn.id = "eg-download-btn";
  downloadBtn.src = "https://cdn-icons-png.flaticon.com/128/1091/1091007.png";
  downloadBtn.style.position = "fixed";
  downloadBtn.style.top = "10px";
  downloadBtn.style.right = "10px";
  downloadBtn.style.width = "38px";
  downloadBtn.style.height = "38px";
  downloadBtn.style.cursor = "pointer";
  downloadBtn.style.zIndex = "999999";
  document.body.appendChild(downloadBtn);

  downloadBtn.onclick = function(){
    const botMsgs = document.querySelectorAll(".message-row.bot, .msg.bot");
    if(!botMsgs.length) return alert("Nenhuma mensagem do bot.");

    const lastBot = botMsgs[botMsgs.length - 1];
    let code = lastBot.innerText || lastBot.textContent;
    code = code.trim();
    if(!code) return alert("C√≥digo vazio.");

    // Limpa lixo antes do c√≥digo real
    let start = 0;
    if(code.includes("<!DOCTYPE")) start = code.indexOf("<!DOCTYPE");
    else if(code.includes("<?php")) start = code.indexOf("<?php");
    code = code.substring(start);

    // Detecta extens√£o
    let ext = ".txt";
    if(code.includes("<html")) ext = ".html";
    if(code.startsWith("<?php")) ext = ".php";

    const blob = new Blob([code], { type: "text/plain" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "arquivo-gerado" + ext;
    a.click();
  };

  /* ================= BOT√ÉO LIXEIRA ================= */
  const clearBtn = document.createElement("img");
  clearBtn.id = "eg-clear-btn";
  clearBtn.src = "https://cdn-icons-png.flaticon.com/128/10337/10337388.png";
  clearBtn.style.position = "fixed";
  clearBtn.style.top = "10px";
  clearBtn.style.right = "56px";
  clearBtn.style.width = "38px";
  clearBtn.style.height = "38px";
  clearBtn.style.cursor = "pointer";
  clearBtn.style.zIndex = "999999";
  document.body.appendChild(clearBtn);

  clearBtn.onclick = function(){
    localStorage.clear();
    alert("Tudo apagado! Conversas e mente resetadas.");
    location.reload();
    // recarregar automaticamente
  };

})();
</script>
  </body>
</html>
