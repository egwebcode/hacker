<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Consultador CPF (Robusto)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{
  font-family: Arial, Helvetica, sans-serif;
  background:#f4f4f4;
  margin:0;
  padding:20px;
}
.container{
  background:#fff;
  max-width:1100px;
  margin:auto;
  padding:20px;
  border:1px solid #ccc;
}
h1{ margin:0 0 10px; text-align:center; }
textarea{
  width:100%;
  padding:10px;
  font-family: Consolas, monospace;
  font-size:14px;
}
#lista{ height:160px; }
#saida, #logs{
  height:320px;
  overflow:auto;
  white-space:pre-wrap;
}
#saida{ background:#111; color:#eee; }
#logs{
  background:#fafafa;
  border:1px solid #ccc;
  margin-top:10px;
  font-size:13px;
}
button{
  padding:10px 14px;
  margin:6px 4px 0 0;
  cursor:pointer;
}
.status{
  margin-top:10px;
  font-size:14px;
}
.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}
@media(max-width:900px){
  .grid{ grid-template-columns:1fr; }
}
</style>
</head>
<body>

<div class="container">
  <h1>Consultador CPF (JSON Robusto)</h1>

  <label>Cole os CPFs (um por linha – com ou sem caracteres)</label>
  <textarea id="lista" placeholder="000.790.814-72&#10;00179081453"></textarea>

  <div>
    <button onclick="consultar()">Consultar</button>
    <button onclick="copiar()">Copiar Resultado</button>
    <button onclick="baixar()">Baixar TXT</button>
    <button onclick="limpar()">Limpar</button>
  </div>

  <div class="status" id="status">Total: 0 | Sucesso: 0 | Erro: 0</div>

  <div class="grid">
    <div>
      <h3>Resultado Final</h3>
      <pre id="saida"></pre>
    </div>
    <div>
      <h3>Logs</h3>
      <pre id="logs"></pre>
    </div>
  </div>
</div>

<script>
const saida = document.getElementById('saida');
const logs = document.getElementById('logs');
const statusEl = document.getElementById('status');

let total = 0, ok = 0, erro = 0;

function log(msg){
  const t = new Date().toLocaleTimeString();
  logs.textContent += `[${t}] ${msg}\n`;
  logs.scrollTop = logs.scrollHeight;
}
function atualizarStatus(){
  statusEl.textContent = `Total: ${total} | Sucesso: ${ok} | Erro: ${erro}`;
}

// Lê resposta como TEXTO e tenta converter para JSON
async function fetchJsonSafe(url, options){
  const res = await fetch(url, options);
  const text = await res.text();
  let json = null;
  try{
    json = JSON.parse(text);
  }catch(e){
    // não é JSON válido
  }
  return {
    ok: res.ok,
    status: res.status,
    text,
    json
  };
}

async function consultar(){
  const cpfs = document.getElementById('lista').value
    .split('\n')
    .map(l => l.replace(/\D/g,'')) // remove caracteres
    .filter(l => l.length === 11);

  if(cpfs.length === 0){
    alert('Nenhum CPF válido (11 dígitos).');
    return;
  }

  // reset
  saida.textContent = '';
  logs.textContent = '';
  total = cpfs.length; ok = 0; erro = 0;
  atualizarStatus();

  log(`Iniciando consulta de ${total} CPFs`);

  for(const cpf of cpfs){
    log(`CPF ${cpf}: iniciando`);

    try{
      // API 1
      const r1 = await fetchJsonSafe(
        'https://corsproxy.io/?https://donald.bet.br/api/documents/validate',
        {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ number: cpf, captcha_token: "" })
        }
      );

      if(!r1.json){
        log(`CPF ${cpf}: API1 retornou NÃO-JSON (HTTP ${r1.status})`);
      }

      // API 2
      const r2 = await fetchJsonSafe(
        'https://corsproxy.io/?https://bateu.bet.br/api/bff/address-by-cpf',
        {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ cpf })
        }
      );

      if(!r2.json){
        log(`CPF ${cpf}: API2 retornou NÃO-JSON (HTTP ${r2.status})`);
      }

      const combinado = {
        validate: r1.json?.data || r1.json || { error: 'Resposta não-JSON', status: r1.status },
        address: r2.json || { error: 'Resposta não-JSON', status: r2.status }
      };

      saida.textContent +=
        JSON.stringify(combinado, null, 2) +
        '\n--------------------------------------\n';

      ok++;
      log(`CPF ${cpf}: concluído`);

    }catch(e){
      erro++;
      log(`CPF ${cpf}: ERRO ${e}`);
    }

    atualizarStatus();
  }

  log('Finalizado');
}

function copiar(){
  navigator.clipboard.writeText(saida.textContent);
  alert('Copiado!');
}
function baixar(){
  const blob = new Blob([saida.textContent], {type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'resultado_cpfs.txt';
  a.click();
}
function limpar(){
  document.getElementById('lista').value = '';
  saida.textContent = '';
  logs.textContent = '';
  total = ok = erro = 0;
  atualizarStatus();
}
</script>

</body>
</html>